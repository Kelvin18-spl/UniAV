<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UniAV | Automated Engineering Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { background-color: #0f172a; background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px); background-size: 40px 40px; }
    .glass-panel { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
    .glow-indigo { box-shadow: 0 0 30px rgba(99, 102, 241, 0.15); }
    .data-font { font-family: 'ui-monospace', monospace; }
    #authOverlay { display: flex; }
    .hidden { display: none !important; }
  </style>
</head>
<body class="text-slate-300 font-sans antialiased">

  <div id="authOverlay" class="fixed inset-0 bg-slate-950/98 backdrop-blur-xl z-[100] items-center justify-center p-6">
    <div class="glass-panel max-w-md w-full rounded-3xl overflow-hidden shadow-2xl border-indigo-500/50">
        <div class="bg-indigo-600 p-8 text-center">
            <h2 id="authTitle" class="text-2xl font-black text-white uppercase italic">UniAV Access</h2>
            <p id="authSub" class="text-indigo-200 text-[10px] font-bold uppercase tracking-widest mt-2">Sign in to continue</p>
        </div>
        <div class="p-8 space-y-4">
            <div id="registerFields" class="space-y-4 hidden">
                <input type="text" id="regName" placeholder="Full Name" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
                <input type="text" id="regOrg" placeholder="Organization" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            </div>
            <input type="email" id="authEmail" placeholder="Email Address" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            <input type="password" id="authPass" placeholder="Password" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            <button id="primaryBtn" onclick="handleAuth()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black text-[11px] uppercase tracking-widest transition-all shadow-lg shadow-indigo-600/20">Sign In</button>
            <div class="text-center">
                <button onclick="toggleAuthMode()" id="toggleBtn" class="text-[10px] text-slate-500 uppercase font-bold hover:text-indigo-400">Need an account? Register</button>
            </div>
            <p id="authMsg" class="text-center text-red-500 text-[10px] font-bold uppercase hidden"></p>
        </div>
    </div>
  </div>

  <div id="mainConsole" class="hidden max-w-7xl mx-auto py-10 px-6">
    <header class="mb-10 flex flex-col items-center">
        <div class="flex items-center gap-5">
            <div class="p-4 bg-indigo-600 rounded-2xl glow-indigo"><i class="fas fa-layer-group text-4xl text-white"></i></div>
            <div>
                <h1 class="text-6xl font-black text-white italic uppercase leading-none tracking-tighter">Uni<span class="text-indigo-500">AV</span></h1>
                <p class="text-indigo-400 font-bold tracking-[0.6em] text-[10px] uppercase mt-2">Universal Hardware Intelligence</p>
            </div>
            <button onclick="logout()" class="ml-12 text-[10px] font-black text-slate-500 border border-slate-800 px-4 py-2 rounded-lg hover:text-white transition-all">LOGOUT</button>
        </div>
    </header>

    <div class="max-w-5xl mx-auto mb-10">
      <div class="glass-panel rounded-2xl p-2 border-l-4 border-indigo-500 glow-indigo">
        <div class="flex items-center bg-slate-900/50 rounded-xl overflow-hidden">
          <div class="pl-5 pr-3 text-indigo-500 text-xl"><i class="fas fa-terminal"></i></div>
          <input id="searchInput" type="text" class="w-full py-5 bg-transparent text-white text-xl font-bold placeholder-slate-600 outline-none" placeholder="SYSTEM_QUERY: Input Brand + Model Number...">
          <div class="pr-6">
             <div id="statusIndicator" class="invisible flex items-center gap-3 bg-indigo-500/10 px-4 py-2 rounded-full border border-indigo-500/30">
                <span class="animate-pulse h-2 w-2 rounded-full bg-indigo-500"></span>
                <span id="statusText" class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Querying</span>
             </div>
          </div>
        </div>
      </div>
    </div>

    <div id="resultContainer" class="hidden">
      <div class="grid lg:grid-cols-4 gap-8">
        <div id="specContent" class="lg:col-span-3 glass-panel rounded-3xl p-10 border-t border-indigo-500/30 shadow-2xl"></div>
        <div class="space-y-6">
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-indigo-500 bg-slate-900/20">
                <h4 class="text-[10px] font-black uppercase tracking-widest text-indigo-400 mb-3">Diagnostic Advisor</h4>
                <div id="aiAdvice" class="text-xs leading-relaxed opacity-70 italic font-medium"></div>
                <div class="mt-4 flex flex-col gap-2">
                    <span id="sourceBadge" class="px-3 py-1 rounded text-[8px] font-black uppercase text-white tracking-widest inline-block text-center"></span>
                    <span id="geminiBadge" class="hidden px-3 py-1 rounded text-[8px] font-black uppercase text-white tracking-widest bg-fuchsia-600 text-center">Gemini Analysis Active</span>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div id="emptyState" class="text-center py-32">
      <i class="fas fa-satellite-dish text-slate-800 text-7xl mb-6 animate-pulse"></i>
      <p class="text-slate-500 font-bold uppercase tracking-[0.4em] text-xs">System Idle // Awaiting Signal</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyC3SkQPM47ei4wzSzqLr1H2-huAAgurQK4",
        authDomain: "av-info-finder.firebaseapp.com",
        projectId: "av-info-finder",
        storageBucket: "av-info-finder.firebasestorage.app",
        messagingSenderId: "19723054060",
        appId: "1:19723054060:web:7d39e54afe4b7fa6aa2ec9",
        measurementId: "G-1ZJ6TGE8NR"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let projectorData = []; 
    let searchTimeout;
    let isLoginMode = true;

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('registerFields').classList.toggle('hidden');
        document.getElementById('authTitle').innerText = isLoginMode ? "UniAV Access" : "Create Account";
        document.getElementById('primaryBtn').innerText = isLoginMode ? "Sign In" : "Register";
        document.getElementById('toggleBtn').innerText = isLoginMode ? "Need an account? Register" : "Have an account? Login";
    }

    async function handleAuth() {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const msg = document.getElementById('authMsg');
        try {
            if (isLoginMode) {
                await auth.signInWithEmailAndPassword(email, pass);
            } else {
                const name = document.getElementById('regName').value;
                const org = document.getElementById('regOrg').value;
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const isAutoApproved = email.toLowerCase().endsWith('@bcu.ac.uk');
                await db.collection('users').doc(userCredential.user.uid).set({
                    name, org, email, approved: isAutoApproved 
                });
            }
        } catch (error) {
            msg.innerText = error.message;
            msg.classList.remove('hidden');
        }
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists && doc.data().approved) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainConsole').classList.remove('hidden');
                initEngine();
            } else {
                alert("Account pending approval. @bcu.ac.uk emails are auto-approved.");
                auth.signOut();
            }
        } else {
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainConsole').classList.add('hidden');
        }
    });

    function logout() { auth.signOut(); location.reload(); }

    async function initEngine() {
        try {
            const response = await fetch('data.json');
            if (response.ok) projectorData = await response.json();
        } catch (e) { console.warn("Local DB offline."); }
    }

    document.getElementById("searchInput").addEventListener("input", (e) => {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);
        if (query.length < 2) { hideResults(); return; }
        searchTimeout = setTimeout(() => performSearch(query), 800);
    });

    async function performSearch(query) {
        const status = document.getElementById("statusIndicator");
        status.classList.remove("invisible");
        const cleanQuery = query.toLowerCase().replace(/[\s\-]/g, "");
        let match = projectorData.find(p => (p.brand + (p.model || "")).toLowerCase().replace(/[\s\-]/g, "").includes(cleanQuery));
        if (match) { 
            displayResults(match, "DB_LOCAL"); 
        } else {
            const groqData = await fetchGroqSpecs(query);
            if (groqData) {
                displayResults(groqData, "GROQ_ENGINE");
                fetchGeminiAdvice(query);
            } else {
                status.classList.add("invisible");
            }
        }
    }

    async function fetchGroqSpecs(model) {
        const prompt = `AV Engineer: Return ONLY JSON for "${model}". 2 sentence description. Keys: brand, model, category, description, ports, lamp_model, brightness, resolution, throw_ratio, lamp_life, filter_model, notes.`;
        try {
            const resp = await fetch("/api/search", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: prompt })
            });
            const d = await resp.json();
            return JSON.parse(d.choices[0].message.content);
        } catch (e) { 
            console.error("Groq Proxy Error:", e);
            return null; 
        }
    }

    async function fetchGeminiAdvice(model) {
        const badge = document.getElementById("geminiBadge");
        const adviceBox = document.getElementById("aiAdvice");
        try {
            const resp = await fetch("/api/advice", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: model })
            });
            const d = await resp.json();
            adviceBox.innerHTML = d.candidates[0].content.parts[0].text;
            badge.classList.remove("hidden");
        } catch (e) { 
            console.warn("Gemini Proxy Failed"); 
        }
    }

    function displayResults(data, source) {
        document.getElementById("statusIndicator").classList.add("invisible");
        document.getElementById("emptyState").classList.add("hidden");
        document.getElementById("resultContainer").classList.remove("hidden");
        document.getElementById("sourceBadge").innerText = source;
        document.getElementById("sourceBadge").className = `px-3 py-1 rounded text-[8px] font-black tracking-widest text-white ${source === 'DB_LOCAL' ? 'bg-slate-700' : 'bg-indigo-600'}`;
        
        let portDisplay = data.ports || "N/A";
        if (typeof portDisplay === 'object') portDisplay = Object.values(portDisplay).join(", ");

        document.getElementById("specContent").innerHTML = `
            <div class="space-y-8">
                <div class="flex justify-between items-start border-b border-slate-800 pb-6">
                    <div>
                        <p class="text-indigo-400 font-bold text-xs tracking-[0.3em] uppercase mb-2">${data.brand}</p>
                        <h2 class="text-5xl font-black text-white tracking-tighter uppercase italic leading-none">${data.model}</h2>
                    </div>
                    <span class="text-[10px] font-bold text-white uppercase border-2 border-slate-700 px-4 py-2 rounded-xl">${data.category}</span>
                </div>
                <p class="text-lg text-slate-400 leading-relaxed font-medium">${data.description || "Hardware profile verified."}</p>
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800 flex justify-between items-center">
                        <span class="text-[12px] text-slate-500 font-black uppercase tracking-widest">Luminance</span>
                        <span class="text-2xl font-bold text-white data-font">${data.brightness || "N/A"}</span>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800 flex justify-between items-center">
                        <span class="text-[12px] text-slate-500 font-black uppercase tracking-widest">Resolution</span>
                        <span class="text-2xl font-bold text-white data-font">${data.resolution || "N/A"}</span>
                    </div>
                </div>
                <div class="p-4 bg-slate-900/80 rounded-lg border border-slate-800">
                    <span class="text-[8px] text-slate-500 font-bold uppercase block mb-1">Ports</span>
                    <span class="text-xs font-medium text-indigo-100 data-font">${portDisplay}</span>
                </div>
            </div>`;
        document.getElementById("aiAdvice").innerHTML = data.notes || "Professional deployment recommended.";
    }

    function hideResults() {
        document.getElementById("resultContainer").classList.add("hidden");
        document.getElementById("emptyState").classList.remove("hidden");
    }
  </script>
</body>
</html>