<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>UniAV | Automated Engineering Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { background-color: #0f172a; background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px); background-size: 40px 40px; }
    .glass-panel { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
    .glow-indigo { box-shadow: 0 0 30px rgba(99, 102, 241, 0.15); }
    .data-font { font-family: 'ui-monospace', monospace; }
    #authOverlay { display: flex; }
    .hidden { display: none !important; }
    input { font-size: 16px !important; }
  </style>
</head>
<body class="text-slate-300 font-sans antialiased">

  <div id="authOverlay" class="fixed inset-0 bg-slate-950/98 backdrop-blur-xl z-[100] items-center justify-center p-4 md:p-6">
    <div class="glass-panel max-w-md w-full rounded-3xl overflow-hidden shadow-2xl border-indigo-500/50">
        <div class="bg-indigo-600 p-6 md:p-8 text-center">
            <h2 id="authTitle" class="text-xl md:text-2xl font-black text-white uppercase italic">UniAV Access</h2>
            <p id="authSub" class="text-indigo-200 text-[9px] md:text-[10px] font-bold uppercase tracking-widest mt-2">Sign in to continue</p>
        </div>
        <div class="p-6 md:p-8 space-y-4">
            <div id="registerFields" class="space-y-4 hidden">
                <input type="text" id="regName" placeholder="Full Name" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
                <input type="text" id="regOrg" placeholder="Organization" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            </div>
            <input type="email" id="authEmail" placeholder="Email Address" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            <input type="password" id="authPass" placeholder="Password" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-indigo-500 transition-all">
            <button id="primaryBtn" onclick="handleAuth()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black text-[11px] uppercase tracking-widest transition-all shadow-lg shadow-indigo-600/20">Sign In</button>
            <div class="text-center">
                <button onclick="toggleAuthMode()" id="toggleBtn" class="text-[10px] text-slate-500 uppercase font-bold hover:text-indigo-400">Need an account? Register</button>
            </div>
            <p id="authMsg" class="text-center text-red-500 text-[10px] font-bold uppercase hidden"></p>
        </div>
    </div>
  </div>

  <div id="mainConsole" class="hidden max-w-7xl mx-auto py-6 md:py-10 px-4 md:px-6">
    <header class="mb-8 md:mb-10 flex flex-col items-center">
        <div class="flex flex-col md:flex-row items-center gap-4 md:gap-5">
            <div class="p-3 md:p-4 bg-indigo-600 rounded-2xl glow-indigo"><i class="fas fa-layer-group text-3xl md:text-4xl text-white"></i></div>
            <div class="text-center md:text-left">
                <h1 class="text-4xl md:text-6xl font-black text-white italic uppercase leading-none tracking-tighter">Uni<span class="text-indigo-500">AV</span></h1>
                <p class="text-indigo-400 font-bold tracking-[0.4em] md:tracking-[0.6em] text-[8px] md:text-[10px] uppercase mt-2">Universal Hardware Intelligence</p>
            </div>
            <button onclick="logout()" class="mt-4 md:mt-0 md:ml-12 text-[9px] md:text-[10px] font-black text-slate-500 border border-slate-800 px-4 py-2 rounded-lg hover:text-white transition-all uppercase">LOGOUT</button>
        </div>
    </header>

    <div class="max-w-5xl mx-auto mb-8 md:mb-10">
      <div class="glass-panel rounded-2xl p-1 md:p-2 border-l-4 border-indigo-500 glow-indigo">
        <div class="flex items-center bg-slate-900/50 rounded-xl overflow-hidden">
          <div class="pl-4 md:pl-5 pr-2 md:pr-3 text-indigo-500 text-lg md:text-xl"><i class="fas fa-terminal"></i></div>
          <input id="searchInput" type="text" class="w-full py-4 md:py-5 bg-transparent text-white text-base md:text-xl font-bold placeholder-slate-600 outline-none" placeholder="QUERY: Brand + Model...">
          <div class="pr-4 md:pr-6 hidden sm:block">
             <div id="statusIndicator" class="invisible flex items-center gap-3 bg-indigo-500/10 px-3 md:px-4 py-2 rounded-full border border-indigo-500/30">
                <span class="animate-pulse h-2 w-2 rounded-full bg-indigo-500"></span>
                <span id="statusText" class="text-[8px] md:text-[9px] font-black text-indigo-400 uppercase tracking-widest">Querying</span>
             </div>
          </div>
        </div>
      </div>
    </div>

    <div id="resultContainer" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 md:gap-8">
        <div id="specContent" class="lg:col-span-3 glass-panel rounded-3xl p-6 md:p-10 border-t border-indigo-500/30 shadow-2xl"></div>
        
        <div class="space-y-6">
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-indigo-500 bg-slate-900/20">
                <h4 class="text-[10px] font-black uppercase tracking-widest text-indigo-400 mb-3">Diagnostic Advisor</h4>
                <div id="aiAdvice" class="text-xs leading-relaxed opacity-70 italic font-medium mb-6"></div>
                
                <div class="pt-4 border-t border-slate-800 flex flex-col gap-3">
                    <p class="text-[8px] font-bold text-slate-600 uppercase tracking-widest">Source Authenticity</p>
                    <div id="sourceBadge" class="px-3 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-widest text-center border border-slate-700"></div>
                    <div id="geminiBadge" class="hidden px-3 py-1.5 rounded-lg text-[8px] font-black uppercase text-white tracking-widest bg-fuchsia-600/20 text-fuchsia-400 border border-fuchsia-500/40 text-center">Gemini Analysis Active</div>
                </div>
            </div>

            <button onclick="toggleModal(true)" class="w-full py-3 border border-red-500/30 text-red-400 text-[9px] font-black uppercase tracking-widest rounded-xl hover:bg-red-500/10 transition-all">
                <i class="fas fa-exclamation-triangle mr-2"></i> Report Data Mismatch
            </button>
        </div>
      </div>
    </div>

    <div id="emptyState" class="text-center py-20 md:py-32">
      <i class="fas fa-satellite-dish text-slate-800 text-5xl md:text-7xl mb-6 animate-pulse"></i>
      <p class="text-slate-500 font-bold uppercase tracking-[0.3em] md:tracking-[0.4em] text-[10px] md:text-xs">System Idle // Awaiting Signal</p>
    </div>
  </div>

  <div id="calibrationModal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[200] items-center justify-center p-4">
    <div class="glass-panel max-w-lg w-full rounded-3xl overflow-hidden border-red-500/50 shadow-2xl">
        <div class="bg-red-600 p-6 text-center">
            <h3 class="text-white font-black uppercase italic tracking-tighter text-xl">Technical Correction</h3>
        </div>
        <div class="p-8 space-y-6">
            <textarea id="correctionInput" placeholder="Enter verified technical details..." class="w-full h-40 bg-slate-900 border border-slate-800 rounded-xl p-4 text-white text-sm outline-none focus:border-red-500 transition-all"></textarea>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="copyCorrection()" class="py-3 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase hover:bg-slate-700 transition-all">Copy Text</button>
                <button onclick="sendDispatch()" class="py-3 bg-red-600 text-white rounded-xl text-[10px] font-black uppercase hover:bg-red-500 transition-all">Send Email</button>
            </div>
            <button onclick="toggleModal(false)" class="w-full text-[9px] text-slate-500 font-bold uppercase tracking-widest hover:text-white">Cancel</button>
        </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyC3SkQPM47ei4wzSzqLr1H2-huAAgurQK4",
        authDomain: "av-info-finder.firebaseapp.com",
        projectId: "av-info-finder",
        storageBucket: "av-info-finder.firebasestorage.app",
        messagingSenderId: "19723054060",
        appId: "1:19723054060:web:7d39e54afe4b7fa6aa2ec9",
        measurementId: "G-1ZJ6TGE8NR"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let projectorData = []; 
    let currentModelName = "";
    let currentThrowRatio = ""; 
    let searchTimeout;
    let isLoginMode = true;

    window.toggleModal = (show) => {
        const modal = document.getElementById('calibrationModal');
        modal.classList.toggle('hidden', !show);
        modal.classList.toggle('flex', show);
    };

    window.copyCorrection = () => {
        const val = document.getElementById('correctionInput').value;
        navigator.clipboard.writeText(`Correction for ${currentModelName}: ${val}`);
        alert("Copied to clipboard.");
    };

    window.sendDispatch = () => {
        const val = document.getElementById('correctionInput').value;
        const subject = encodeURIComponent(`UniAV Correction: ${currentModelName}`);
        const body = encodeURIComponent(`Model: ${currentModelName}\nVerified Details:\n\n${val}`);
        window.location.href = `mailto:kelvin.cheng@bcu.ac.uk?subject=${subject}&body=${body}`;
    };

    window.calc = function(dist) {
        const res = document.getElementById('lensResults');
        const rMatch = currentThrowRatio.match(/(\d+\.?\d*)/);
        if (!rMatch || !dist) return;
        res.innerHTML = `${Math.round((parseFloat(dist) / parseFloat(rMatch[0])) * 1.15 * 39.37)}" DIAG`;
    };

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('registerFields').classList.toggle('hidden');
        document.getElementById('authTitle').innerText = isLoginMode ? "UniAV Access" : "Create Account";
        document.getElementById('primaryBtn').innerText = isLoginMode ? "Sign In" : "Register";
        document.getElementById('toggleBtn').innerText = isLoginMode ? "Need an account? Register" : "Have an account? Login";
    }

    async function handleAuth() {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const msg = document.getElementById('authMsg');
        try {
            if (isLoginMode) {
                await auth.signInWithEmailAndPassword(email, pass);
            } else {
                const name = document.getElementById('regName').value;
                const org = document.getElementById('regOrg').value;
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const isAutoApproved = email.toLowerCase().endsWith('@bcu.ac.uk');
                await db.collection('users').doc(userCredential.user.uid).set({ name, org, email, approved: isAutoApproved });
            }
        } catch (error) {
            msg.innerText = error.message;
            msg.classList.remove('hidden');
        }
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists && doc.data().approved) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainConsole').classList.remove('hidden');
                initEngine();
            } else {
                alert("Approval pending.");
                auth.signOut();
            }
        } else {
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainConsole').classList.add('hidden');
        }
    });

    function logout() { auth.signOut(); location.reload(); }

    async function initEngine() {
        try {
            const response = await fetch('data.json');
            if (response.ok) projectorData = await response.json();
        } catch (e) { console.warn("Local DB offline."); }
    }

    document.getElementById("searchInput").addEventListener("input", (e) => {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);
        if (query.length < 2) { hideResults(); return; }
        searchTimeout = setTimeout(() => performSearch(query), 800);
    });

    async function performSearch(query) {
        const status = document.getElementById("statusIndicator");
        status.classList.remove("invisible");
        const cleanQuery = query.toLowerCase().replace(/[\s\-]/g, "");
        let match = projectorData.find(p => (p.brand + (p.model || "")).toLowerCase().replace(/[\s\-]/g, "").includes(cleanQuery));
        
        if (match) { 
            displayResults(match, "DB_LOCAL"); 
        } else {
            const groqData = await fetchGroqSpecs(query);
            if (groqData) {
                displayResults(groqData, "GROQ_ENGINE");
                fetchGeminiAdvice(query);
            } else {
                status.classList.add("invisible");
            }
        }
    }

    async function fetchGroqSpecs(model) {
        const prompt = `AV Engineer: Return ONLY JSON for "${model}". 2 sentence description. Keys: brand, model, category, description, ports, lamp_model, brightness, resolution, throw_ratio, lamp_life, filter_model, notes.`;
        try {
            const resp = await fetch("/api/search", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: prompt })
            });
            const d = await resp.json();
            return JSON.parse(d.choices[0].message.content);
        } catch (e) { return null; }
    }

    async function fetchGeminiAdvice(model) {
        const badge = document.getElementById("geminiBadge");
        const adviceBox = document.getElementById("aiAdvice");
        try {
            const resp = await fetch("/api/advice", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: model })
            });
            const d = await resp.json();
            adviceBox.innerHTML = d.candidates[0].content.parts[0].text;
            badge.classList.remove("hidden");
        } catch (e) { console.warn("Gemini Proxy Failed"); }
    }

    function displayResults(data, source) {
        currentModelName = `${data.brand} ${data.model}`;
        currentThrowRatio = data.throw_ratio || "";

        document.getElementById("statusIndicator").classList.add("invisible");
        document.getElementById("emptyState").classList.add("hidden");
        document.getElementById("resultContainer").classList.remove("hidden");
        
        // SOURCE BADGE UPDATE
        const badge = document.getElementById("sourceBadge");
        badge.innerText = source === "DB_LOCAL" ? "Internal DB Verified" : "External AI Synthesis";
        badge.className = `px-3 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-widest border ${source === 'DB_LOCAL' ? 'text-emerald-400 border-emerald-500/30 bg-emerald-500/5' : 'text-indigo-400 border-indigo-500/30 bg-indigo-500/5'}`;
        
        let portDisplay = data.ports || "N/A";
        if (typeof portDisplay === 'object') portDisplay = Object.values(portDisplay).join(", ");

        const isProj = (data.category || "").toLowerCase().includes("projector") || (data.lamp_model && data.lamp_model !== "N/A");

        document.getElementById("specContent").innerHTML = `
            <div class="space-y-6 md:y-8">
                <div class="flex flex-col md:flex-row justify-between items-start border-b border-slate-800 pb-6 gap-4">
                    <div>
                        <p class="text-indigo-400 font-bold text-[10px] md:text-xs tracking-[0.3em] uppercase mb-1 md:mb-2">${data.brand}</p>
                        <h2 class="text-3xl md:text-5xl font-black text-white tracking-tighter uppercase italic leading-tight md:leading-none">${data.model}</h2>
                    </div>
                    <span class="text-[9px] md:text-[10px] font-bold text-white uppercase border-2 border-slate-700 px-3 md:px-4 py-1.5 md:py-2 rounded-xl">${data.category}</span>
                </div>
                <p class="text-base md:text-lg text-slate-400 leading-relaxed font-medium">${data.description || "Hardware profile verified."}</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-slate-900/50 p-4 md:p-6 rounded-2xl border border-slate-800 flex justify-between items-center">
                        <span class="text-[10px] md:text-[12px] text-slate-500 font-black uppercase tracking-widest">Luminance</span>
                        <span class="text-xl md:text-2xl font-bold text-white data-font">${data.brightness || "N/A"}</span>
                    </div>
                    <div class="bg-slate-900/50 p-4 md:p-6 rounded-2xl border border-slate-800 flex justify-between items-center">
                        <span class="text-[10px] md:text-[12px] text-slate-500 font-black uppercase tracking-widest">Resolution</span>
                        <span class="text-xl md:text-2xl font-bold text-white data-font">${data.resolution || "N/A"}</span>
                    </div>
                </div>

                ${isProj ? `
                <div class="space-y-3 border-l-2 border-indigo-500/30 pl-4 py-1">
                    <p class="text-[9px] font-black text-indigo-500/60 uppercase tracking-widest">Maintenance & Optics</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="p-3 bg-indigo-500/5 border border-indigo-500/20 rounded-lg flex justify-between items-center">
                            <span class="text-[10px] text-indigo-400 font-bold uppercase">Lamp Life</span>
                            <span class="text-sm font-bold text-white data-font">${data.lamp_life || "N/A"}</span>
                        </div>
                        <div class="p-3 bg-indigo-500/5 border border-indigo-500/20 rounded-lg flex justify-between items-center">
                            <span class="text-[10px] text-indigo-400 font-bold uppercase">Filter Model</span>
                            <span class="text-sm font-bold text-white data-font">${data.filter_model || "N/A"}</span>
                        </div>
                    </div>
                    <div class="p-3 bg-slate-900/80 rounded-lg border border-slate-800 flex justify-between items-center">
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Lamp Model</span>
                        <span class="text-sm font-medium text-indigo-100 data-font">${data.lamp_model || "N/A"}</span>
                    </div>
                    ${currentThrowRatio && currentThrowRatio !== "N/A" ? `
                    <div class="p-3 bg-emerald-500/5 border border-emerald-500/20 rounded-lg flex flex-col sm:flex-row items-center gap-4">
                        <div class="flex-1 w-full">
                            <p class="text-[11px] text-emerald-500 font-black uppercase mb-1">Optic Calculator (${currentThrowRatio})</p>
                            <input type="number" step="0.1" placeholder="Distance (m)" class="w-full bg-slate-950 border border-slate-800 text-white p-2 rounded text-xs outline-none focus:border-emerald-500" oninput="window.calc(this.value)">
                        </div>
                        <div id="lensResults" class="text-2xl font-black text-emerald-400 data-font">---" DIAG</div>
                    </div>` : ''}
                </div>` : ''}

                <div class="p-4 bg-slate-900/80 rounded-lg border border-slate-800">
                    <span class="text-[8px] text-slate-500 font-bold uppercase block mb-1">Interface Ports</span>
                    <span class="text-[11px] md:text-xs font-medium text-indigo-100 data-font break-words">${portDisplay}</span>
                </div>
            </div>`;
        
        document.getElementById("aiAdvice").innerHTML = data.notes || "Professional deployment recommended.";
    }

    function hideResults() {
        document.getElementById("resultContainer").classList.add("hidden");
        document.getElementById("emptyState").classList.remove("hidden");
    }
  </script>
</body>
</html>